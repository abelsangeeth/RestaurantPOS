@model RestaurantPOS.Models.DeliveryViewModel
@{
    ViewData["Title"] = "Order Delivery";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - @Model.RestaurantName</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 1000;
            animation: slideInUp 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }

        @@keyframes slideInUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @@keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">

    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-extrabold text-white">@Model.RestaurantName</h1>
                <p class="text-gray-400">Welcome, @Model.Customer.Name!</p>
            </div>
            <div class="flex items-center gap-4">
                <a href="@Url.Action("OrderHistory", "Delivery")" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    My Orders
                </a>
                <form asp-action="Logout" asp-controller="Delivery" method="post">
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Logout
                    </button>
                </form>
            </div>
        </header>

        @if (TempData["Success"] != null)
        {
            <div class="bg-green-500 text-white p-4 rounded-lg mb-6">@TempData["Success"]</div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="bg-red-500 text-white p-4 rounded-lg mb-6">@TempData["Error"]</div>
        }

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Menu Items -->
            <div class="lg:col-span-2">
                <h2 class="text-3xl font-bold mb-6 text-white">📋 Menu</h2>
                <div class="space-y-8">
                    @foreach (var group in Model.MenuItems.GroupBy(m => m.Category))
                    {
                        <div>
                            <h3 class="text-2xl font-semibold mb-4 text-purple-400">@group.Key</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                @foreach (var item in group)
                                {
                                    <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-700 hover:border-purple-500 transition-all">
                                        <div class="p-6">
                                            <div class="flex justify-between items-start">
                                                <h4 class="text-xl font-bold text-white">@item.Name</h4>
                                                <p class="text-lg font-bold text-green-400">$@item.Price.ToString("F2")</p>
                                            </div>
                                            <p class="text-gray-400 mt-2 mb-4">@item.Description</p>
                                            <button onclick="addToCart(@item.Id)" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                                Add to Cart
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Shopping Cart -->
            <div class="lg:col-span-1">
                <div class="sticky top-8">
                    <div class="bg-gray-800 rounded-xl shadow-lg border border-gray-700">
                        <div class="p-6">
                            <h3 class="text-2xl font-bold text-white mb-4">🛒 Your Order</h3>
                            <div id="cart-items" class="space-y-4 mb-6 min-h-[150px]">
                                @await Html.PartialAsync("_CartPartial", Model.CurrentOrder)
                            </div>

                            <div class="border-t border-gray-700 pt-4 space-y-2">
                                <div class="flex justify-between text-lg">
                                    <span class="text-gray-400">Subtotal</span>
                                    <span id="cart-subtotal" class="font-bold text-white">$@(Model.CurrentOrder.DisplayTotal.ToString("F2"))</span>
                                </div>
                                <div class="flex justify-between text-lg">
                                    <span class="text-gray-400">Delivery Fee</span>
                                    <span class="font-bold text-white">$5.00</span>
                                </div>
                                <div class="flex justify-between text-2xl font-bold text-white">
                                    <span>Total</span>
                                    <span id="cart-total" class="text-green-400">$@((Model.CurrentOrder.DisplayTotal + 5.00m).ToString("F2"))</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-700/50 p-6 rounded-b-xl">
                            <form id="place-order-form" class="space-y-4">
                                @Html.AntiForgeryToken()
                                <div>
                                    <label for="deliveryAddress" class="block text-sm font-medium text-gray-300 mb-1">Delivery Address</label>
                                    <input type="text" id="deliveryAddress" name="deliveryAddress" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg text-white" placeholder="Your full address" required>
                                </div>
                                <div>
                                    <label for="deliveryPhone" class="block text-sm font-medium text-gray-300 mb-1">Phone Number</label>
                                    <input type="tel" id="deliveryPhone" name="deliveryPhone" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg text-white" placeholder="For delivery updates" required>
                                </div>
                                <div>
                                    <label for="notes" class="block text-sm font-medium text-gray-300 mb-1">Order Notes (Optional)</label>
                                    <textarea id="notes" name="notes" rows="2" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg text-white" placeholder="Any special instructions..."></textarea>
                                </div>
                                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors text-lg"
                                        @(Model.CurrentOrder.Items.Any() ? "" : "disabled")>
                                    Place Order
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

        async function addToCart(itemId) {
            const response = await fetch('@Url.Action("AddToCart", "Delivery")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': token },
                body: new URLSearchParams({ itemId: itemId })
            });
            const result = await response.json();
            showNotification(result.message, result.success ? 'success' : 'error');
            if (result.success) {
                await refreshCart();
            }
        }

        async function removeFromCart(itemId) {
            const response = await fetch('@Url.Action("RemoveFromCart", "Delivery")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': token },
                body: `itemId=${itemId}`
            });
            const result = await response.json();
            showNotification(result.message, result.success ? 'success' : 'error');
            if (result.success) {
                await refreshCart();
            }
        }

        async function refreshCart() {
            const response = await fetch('@Url.Action("GetCartPartial", "Delivery")');
            const cartHtml = await response.text();
            document.getElementById('cart-items').innerHTML = cartHtml;

            // Also update totals
            const totalResponse = await fetch('@Url.Action("GetCartTotals", "Delivery")');
            const totals = await totalResponse.json();
            if (totals.success) {
                const subtotal = totals.subtotal;
                const deliveryFee = 5.00;
                document.getElementById('cart-subtotal').textContent = `$${subtotal.toFixed(2)}`;
                document.getElementById('cart-total').textContent = `$${(subtotal + deliveryFee).toFixed(2)}`;
                document.querySelector('#place-order-form button').disabled = totals.itemCount === 0;
            }
        }

        document.getElementById('place-order-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const response = await fetch('@Url.Action("PlaceOrder", "Delivery")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': token },
                body: new URLSearchParams(formData).toString()
            });
            const result = await response.json();
            if (result.success) {
                window.location.href = result.redirectUrl;
            } else {
                showNotification(result.message, 'error');
            }
        });

        function showNotification(message, type) {
            const div = document.createElement('div');
            div.className = `notification ${type}`;
            div.textContent = message;
            document.body.appendChild(div);
        }
    </script>
</body>
</html>